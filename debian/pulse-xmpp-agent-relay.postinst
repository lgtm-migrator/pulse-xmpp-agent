#!/bin/sh
set -e

systemctl daemon-reload

case "$1" in
    configure)
        if ! getent passwd | grep -q "^reversessh:"; then
            echo -n "Adding user reversessh..."
            adduser --home /var/lib/pulse2/clients/reversessh \
                    --shell /bin/rbash \
                    --disabled-password \
                    reversessh 2>/dev/null || true
            echo "..done"
        fi
        if [ ! -f "/var/lib/pulse2/clients/reversessh/.ssh/id_rsa" ]; then
            echo -n "Generating ssh key..."
            mkdir -p /var/lib/pulse2/clients/reversessh/.ssh
            ssh-keygen -q -N "" -b 2048 -t rsa -f /var/lib/pulse2/clients/reversessh/.ssh/id_rsa
            cp -a /var/lib/pulse2/clients/reversessh/.ssh/id_rsa.pub /var/lib/pulse2/clients/reversessh/.ssh/authorized_keys
            chown -R reversessh: /var/lib/pulse2/clients/reversessh/.ssh
            chmod 700 /var/lib/pulse2/clients/reversessh/.ssh
            chmod 600 /var/lib/pulse2/clients/reversessh/.ssh/authorized_keys
            echo "..done"
        fi

        ;;
esac

#DEBHELPER#

exit 0
